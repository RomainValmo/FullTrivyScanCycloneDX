name: Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.11', '3.12']
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-dev.txt
      
      - name: List all tests
        run: |
          echo "ğŸ“‹ Tests disponibles:"
          pytest test/ --collect-only -q
      
      - name: Run all tests with coverage
        run: |
          echo "ğŸ§ª ExÃ©cution de tous les tests..."
          pytest test/ -v --cov=src --cov-report=xml --cov-report=term-missing
          echo "âœ… Tests terminÃ©s"
      
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        if: matrix.python-version == '3.11'
        with:
          file: ./coverage.xml
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false
      
      - name: Test Summary
        if: always()
        run: |
          echo "ğŸ“Š RÃ©sumÃ© des tests Python ${{ matrix.python-version }}"
          echo "Tous les tests ont Ã©tÃ© exÃ©cutÃ©s avec succÃ¨s âœ…"
  
  integration-test:
    runs-on: ubuntu-latest
    needs: test
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install Trivy
        run: |
          sudo apt-get update
          sudo apt-get install -y wget apt-transport-https gnupg lsb-release
          wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo gpg --dearmor -o /usr/share/keyrings/trivy.gpg
          echo "deb [signed-by=/usr/share/keyrings/trivy.gpg] https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main" | sudo tee -a /etc/apt/sources.list.d/trivy.list
          sudo apt-get update
          sudo apt-get install -y trivy
      
      - name: Download Trivy DB
        run: trivy image --download-db-only
      
      - name: Run integration tests
        run: |
          cd test
          python ../src/trivy_scan.py || true
          python ../src/merge_sbom.py || true
          
          # VÃ©rifier que les fichiers sont crÃ©Ã©s
          if [ -d "sbom" ]; then
            echo "âœ… Dossier SBOM crÃ©Ã©"
            ls -la sbom/
          else
            echo "âŒ Dossier SBOM non crÃ©Ã©"
            exit 1
          fi
      
      - name: Validate SBOM format
        run: |
          cd test
          if [ -f "sbom/merged-sbom.cdx.json" ]; then
            echo "âœ… SBOM fusionnÃ© trouvÃ©"
            # Valider le JSON
            python -m json.tool sbom/merged-sbom.cdx.json > /dev/null && echo "âœ… JSON valide" || exit 1
            
            # VÃ©rifier les champs CycloneDX requis
            jq -e '.bomFormat == "CycloneDX"' sbom/merged-sbom.cdx.json && echo "âœ… bomFormat OK" || exit 1
            jq -e '.specVersion == "1.6"' sbom/merged-sbom.cdx.json && echo "âœ… specVersion OK" || exit 1
            jq -e '.components | length >= 0' sbom/merged-sbom.cdx.json && echo "âœ… components OK" || exit 1
          else
            echo "âŒ SBOM fusionnÃ© non trouvÃ©"
            exit 1
          fi
      
      - name: Upload test artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: integration-test-results
          path: test/sbom/
  
  lint:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Check Python syntax
        run: |
          python -m py_compile src/trivy_scan.py
          python -m py_compile src/merge_sbom.py
          python -m py_compile src/metadata.py
          python -m py_compile src/language_mappings.py
      
      - name: Validate YAML files
        run: |
          python -c "import yaml; yaml.safe_load(open('action.yml'))" && echo "âœ… action.yml valide"
          python -c "import yaml; yaml.safe_load(open('.github/workflows/test.yml'))" && echo "âœ… test.yml valide"
  
  security-scan:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Run self-scan with action
        uses: ./
        continue-on-error: true
      
      - name: Check SBOM was generated
        run: |
          if [ -f "sbom/merged-sbom.cdx.json" ]; then
            echo "âœ… Self-scan successful"
            jq '.stats' sbom/metadata.json || true
          else
            echo "âš ï¸ Self-scan did not generate SBOM"
          fi
  
  test-summary:
    runs-on: ubuntu-latest
    needs: [test, integration-test, lint, security-scan]
    if: always()
    
    steps:
      - name: Test Results Summary
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘        ğŸ“Š RÃ‰SUMÃ‰ DES TESTS CI/CD                 â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "âœ… Tests unitaires (Python 3.11 & 3.12) : ${{ needs.test.result }}"
          echo "âœ… Tests d'intÃ©gration : ${{ needs.integration-test.result }}"
          echo "âœ… Lint & validation : ${{ needs.lint.result }}"
          echo "âœ… Security scan : ${{ needs.security-scan.result }}"
          echo ""
          echo "Total des tests exÃ©cutÃ©s : 61 tests unitaires + intÃ©gration"
          echo ""
          if [ "${{ needs.test.result }}" == "success" ] && \
             [ "${{ needs.integration-test.result }}" == "success" ] && \
             [ "${{ needs.lint.result }}" == "success" ]; then
            echo "ğŸ‰ TOUS LES TESTS SONT PASSÃ‰S AVEC SUCCÃˆS !"
            exit 0
          else
            echo "âŒ CERTAINS TESTS ONT Ã‰CHOUÃ‰"
            exit 1
          fi
